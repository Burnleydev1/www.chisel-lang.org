<html><head><title>Chisel/FIRRTL: Blackboxes</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="the Chisel/FIRRTL Developers" /><meta name="description" content="Chisel/FIRRTL
Hardware Compiler Framework" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="Chisel/FIRRTL: Blackboxes" /><meta name="title" property="og:title" content="Chisel/FIRRTL: Blackboxes" /><meta name="og:site_name" content="Chisel/FIRRTL" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Chisel/FIRRTL
Hardware Compiler Framework" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Chisel/FIRRTL: Blackboxes" /><meta name="twitter:image" content="https://freechipsproject.github.io/www.chisel-lang.org//img/poster.png" /><meta name="twitter:description" content="Chisel/FIRRTL
Hardware Compiler Framework" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="@chisel_lang" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/default.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Chisel/FIRRTL</span></div></a></li> <li><a href="/chisel3/index.html" class="">Chisel3</a> <ul class="sub_section"> <li><a href="/chisel3/faqs.html" class="">FAQs</a></li> <li><a href="/chisel3/cookbook.html" class="">Cookbook</a></li> <li><a href="/chisel3/troubleshooting" class="">Troubleshooting</a></li></ul></li> <li><a href="/chisel3/introduction.html" class="">Introduction</a></li> <li><a href="/chisel3/supported-hardware.html" class="">Supported Hardware</a></li> <li><a href="/chisel3/data-types.html" class="">Data Types</a></li> <li><a href="/chisel3/combinational-circuits.html" class="">Combinational Circuits</a></li> <li><a href="/chisel3/operators.html" class="">Operators</a></li> <li><a href="/chisel3/width-inference.html" class="">Width Inference</a></li> <li><a href="/chisel3/functional-abstraction.html" class="">Functional Abstraction</a></li> <li><a href="/chisel3/bundles-and-vecs.html" class="">Bundles and Vecs</a></li> <li><a href="/chisel3/ports.html" class="">Ports</a></li> <li><a href="/chisel3/modules.html" class="">Modules</a></li> <li><a href="/chisel3/blackboxes.html" class=" active ">Blackboxes</a></li> <li><a href="/chisel3/sequential-circuits.html" class="">Sequential Circuits</a></li> <li><a href="/chisel3/memories.html" class="">Memories</a></li> <li><a href="/chisel3/interfaces-and-connections.html" class="">Interfaces and Connections</a></li> <li><a href="/chisel3/functional-module-creation.html" class="">Functional Module Creation</a></li> <li><a href="/chisel3/muxes-and-input-selection.html" class="">Muxes and Input Selection</a></li> <li><a href="/chisel3/polymorphism-and-parameterization.html" class="">Polymorphism and Parameterization</a></li> <li><a href="/chisel3/multi-clock.html" class="">Multiple Clock Domains</a></li> <li><a href="/chisel3/printing.html" class="">Printing in Chisel</a></li> <li><a href="/chisel3/annotations.html" class="">Annotations</a></li> <li><a href="/chisel3/unconnected-wires.html" class="">Unconnected Wires</a></li> <li><a href="/chisel3/chisel3-vs-chisel2.html" class="">Appendix</a> <ul class="sub_section"> <li><a href="/chisel3/chisel3-vs-chisel2.html" class="">Chisel3 vs. Chisel3</a></li> <li><a href="/chisel3/experimental-features.html" class="">Experimental Features</a></li></ul></li> <li><a href="/chisel3/developers.html" class="">Developers</a> <ul class="sub_section"> <li><a href="/chisel3/sbt-subproject.html" class="">sbt Subproject</a></li> <li><a href="/chisel3/test-coverage.html" class="">Test Coverage</a></li></ul></li> <li><a href="/api/chisel3/latest/index.html" class="">API Documentation</a> <ul class="sub_section"> <li><a href="/api/chisel3/v3.1.8/index.html" class="">v3.1.8</a></li> <li><a href="/api/chisel3/v3.1.7/index.html" class="">v3.1.7</a></li> <li><a href="/api/chisel3/v3.1.6/index.html" class="">v3.1.6</a></li> <li><a href="/api/chisel3/v3.1.5/index.html" class="">v3.1.5</a></li> <li><a href="/api/chisel3/v3.1.4/index.html" class="">v3.1.4</a></li> <li><a href="/api/chisel3/v3.1.3/index.html" class="">v3.1.3</a></li> <li><a href="/api/chisel3/v3.1.2/index.html" class="">v3.1.2</a></li> <li><a href="/api/chisel3/v3.1.1/index.html" class="">v3.1.1</a></li> <li><a href="/api/chisel3/v3.1.0/index.html" class="">v3.1.0</a></li> <li><a href="/api/chisel3/v3.0.2/index.html" class="">v3.0.2</a></li> <li><a href="/api/chisel3/v3.0.1/index.html" class="">v3.0.1</a></li></ul></li>        </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"></ul></div></div></div></div><div id="content" data-github-owner="freechipsproject" data-github-repo="www.chisel-lang.org"><div class="content-wrapper"><section><p>Chisel <em>BlackBoxes</em> are used to instantiate externally defined modules. This construct is useful
for hardware constructs that cannot be described in Chisel and for connecting to FPGA or other IP not defined in Chisel.</p>

<p>Modules defined as a <code class="highlighter-rouge">BlackBox</code> will be instantiated in the generated Verilog, but no code
will be generated to define the behavior of module.</p>

<p>Unlike Module, BlackBox has no implicit clock and reset. Ports declared
in the IO Bundle will be generated with the requested name (ie. no preceding <code class="highlighter-rouge">io_</code>).</p>

<h3 id="parameterization">Parameterization</h3>

<p><strong>This is an experimental feature and is subject to API change</strong></p>

<p>Verilog parameters can be passed as an argument to the BlackBox constructor.</p>

<p>For example, consider instantiating a Xilinx differential clock buffer (IBUFDS) in a Chisel design:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">chisel3._</span>
<span class="k">import</span> <span class="nn">chisel3.util._</span>
<span class="k">import</span> <span class="nn">chisel3.experimental._</span> <span class="c1">// To enable experimental features
</span>
<span class="k">class</span> <span class="nc">IBUFDS</span> <span class="k">extends</span> <span class="nc">BlackBox</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="s">"DIFF_TERM"</span> <span class="o">-&gt;</span> <span class="s">"TRUE"</span><span class="o">,</span>
                                  <span class="s">"IOSTANDARD"</span> <span class="o">-&gt;</span> <span class="s">"DEFAULT"</span><span class="o">))</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">O</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">Clock</span><span class="o">())</span>
    <span class="k">val</span> <span class="n">I</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Clock</span><span class="o">())</span>
    <span class="k">val</span> <span class="nc">IB</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Clock</span><span class="o">())</span>
  <span class="o">})</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Top</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span><span class="o">{})</span>
  <span class="k">val</span> <span class="n">ibufds</span> <span class="k">=</span> <span class="nc">Module</span><span class="o">(</span><span class="k">new</span> <span class="nc">IBUFDS</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the Chisel-generated Verilog code, <code class="highlighter-rouge">IBUFDS</code> will be instantiated as:</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IBUFDS</span> <span class="p">#(</span><span class="o">.</span><span class="n">DIFF_TERM</span><span class="p">(</span><span class="s">"TRUE"</span><span class="p">)</span><span class="o">,</span> <span class="o">.</span><span class="n">IOSTANDARD</span><span class="p">(</span><span class="s">"DEFAULT"</span><span class="p">))</span> <span class="n">ibufds</span> <span class="p">(</span>
  <span class="o">.</span><span class="n">IB</span><span class="p">(</span><span class="n">ibufds_IB</span><span class="p">)</span><span class="o">,</span>
  <span class="o">.</span><span class="n">I</span><span class="p">(</span><span class="n">ibufds_I</span><span class="p">)</span><span class="o">,</span>
  <span class="o">.</span><span class="n">O</span><span class="p">(</span><span class="n">ibufds_O</span><span class="p">)</span>
<span class="p">)</span><span class="o">;</span>
</code></pre></div></div>

<h3 id="providing-implementations-for-blackboxes">Providing Implementations for Blackboxes</h3>
<p>The Chisel Execution Harness (see <a href="Running-Stuff">Running Stuff</a>) provides the following ways of delivering the code underlying the blackbox.  Consider the following blackbox that adds two real numbers together.  The numbers are represented in chisel3 as 64-bit unsigned integers.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BlackBoxRealAdd</span> <span class="k">extends</span> <span class="nc">BlackBox</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">in1</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">in2</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The implementation is described by the following verilog</p>
<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="n">BlackBoxRealAdd</span><span class="p">(</span>
    <span class="kt">input</span>  <span class="p">[</span><span class="mi">63</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">in1</span><span class="o">,</span>
    <span class="kt">input</span>  <span class="p">[</span><span class="mi">63</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">in2</span><span class="o">,</span>
    <span class="kt">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mi">63</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">out</span>
<span class="p">)</span><span class="o">;</span>
  <span class="k">always</span> <span class="o">@*</span> <span class="k">begin</span>
  <span class="n">out</span> <span class="o">&lt;=</span> <span class="p">$</span><span class="nb">realtobits</span><span class="p">($</span><span class="nb">bitstoreal</span><span class="p">(</span><span class="n">in1</span><span class="p">)</span> <span class="o">+</span> <span class="p">$</span><span class="nb">bitstoreal</span><span class="p">(</span><span class="n">in2</span><span class="p">))</span><span class="o">;</span>
  <span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div></div>

<h3 id="blackboxes-with-verilog-in-a-resource-file">Blackboxes with Verilog in a Resource File</h3>
<p>In order to deliver the verilog snippet above to the backend simulator, chisel3 provides the following tools based on the chisel/firrtl <a href="Annotations-Extending-Chisel-and-Firrtl">annotation system</a>.  Add the trait <code class="highlighter-rouge">HasBlackBoxResource</code> to the declaration, and then call a function in the body to say where the system can find the verilog.  The Module now looks like</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BlackBoxRealAdd</span> <span class="k">extends</span> <span class="nc">BlackBox</span> <span class="k">with</span> <span class="nc">HasBlackBoxResource</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">in1</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">in2</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="n">setResource</span><span class="o">(</span><span class="s">"/real_math.v"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
<p>The verilog snippet above gets put into a resource file names <code class="highlighter-rouge">real_math.v</code>.  What is a resource file? It comes from a java convention of keeping files in a project that are automatically included in library distributions. In a typical chisel3 project, see <a href="https://github.com/ucb-bar/chisel-template">chisel-template</a>, this would be a directory in the source hierarchy</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src/main/resources/real_math.v
</code></pre></div></div>

<h3 id="blackboxes-with-in-line-verilog">Blackboxes with In-line Verilog</h3>
<p>It is also possible to place this verilog directly in the scala source.  Instead of <code class="highlighter-rouge">HasBlackBoxResource</code> use <code class="highlighter-rouge">HasBlackBoxInline</code> and instead of <code class="highlighter-rouge">setResource</code> use <code class="highlighter-rouge">setInline</code>.  The code will look like this.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BlackBoxRealAdd</span> <span class="k">extends</span> <span class="nc">BlackBox</span> <span class="k">with</span> <span class="nc">HasBlackBoxInline</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">in1</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">in2</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">64.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="n">setInline</span><span class="o">(</span><span class="s">"BlackBoxRealAdd.v"</span><span class="o">,</span>
    <span class="n">s</span><span class="s">"""
      |module BlackBoxRealAdd(
      |    input  [15:0] in1,
      |    input  [15:0] in2,
      |    output [15:0] out
      |);
      |always @* begin
      |  out &lt;= $realtobits($bitstoreal(in1) + $bitstoreal(in2));
      |end
      |endmodule
    """</span><span class="o">.</span><span class="n">stripMargin</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
<p>This technique will copy the inline verilog into the target directory under the name <code class="highlighter-rouge">BlackBoxRealAdd.v</code></p>

<h3 id="under-the-hood">Under the Hood</h3>
<p>This mechanism of delivering verilog content to the testing backends is implemented via chisel/firrtl annotations.  The two methods, inline and resource, are two kinds of annotations that are created via the <code class="highlighter-rouge">setInline</code> and <code class="highlighter-rouge">setResource</code> methods calls.  Those annotations are passed through to the chisel-testers which in turn passes them on to firrtl.  The default firrtl verilog compilers have a pass that detects the annotations and moves the files or inline test into the build directory.  For each unique file added, the transform adds a line to a file black_box_verilog_files.f, this file is added to the command line constructed for verilator or vcs to inform them where to look.
The <a href="/ucb-bar/dsptools">dsptools project</a> is a good example of using this feature to build a real number simulation tester based on black boxes.</p>

<h3 id="the-interpreter">The interpreter</h3>
<p>The <a href="/ucb-bar/firrtl-interpreter">firrtl interpreter</a> uses a separate system that allows users to construct scala implementations of the black boxes.  The scala implementation code built into a BlackBoxFactory which is passed down to the interpreter by the execution harness.  The interpreter is a scala simulation tester.  Once again the dsptools project uses this mechanism and is a good place to look at it.</p>
<blockquote>
  <p>It is planned that the BlackBoxFactory will be replaced by integration with the annotation based blackbox methods stuff soon.</p>
</blockquote>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'freechipsproject/www.chisel-lang.org'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>