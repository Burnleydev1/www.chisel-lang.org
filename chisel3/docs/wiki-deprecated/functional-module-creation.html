<html><head><title>Chisel/FIRRTL: Functional Module Creation</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="the Chisel/FIRRTL Developers" /><meta name="description" content="Chisel/FIRRTL
Hardware Compiler Framework" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="Chisel/FIRRTL: Functional Module Creation" /><meta name="title" property="og:title" content="Chisel/FIRRTL: Functional Module Creation" /><meta name="og:site_name" content="Chisel/FIRRTL" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Chisel/FIRRTL
Hardware Compiler Framework" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Chisel/FIRRTL: Functional Module Creation" /><meta name="twitter:image" content="https://www.chisel-lang.org/img/poster.png" /><meta name="twitter:description" content="Chisel/FIRRTL
Hardware Compiler Framework" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="@chisel_lang" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/default.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-145179088-1' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Chisel/FIRRTL</span></div></a></li> <li><a href="/chisel3/" class="">Chisel3</a></li> <li><a href="/chisel3/cookbooks.html" class="">Cookbooks</a> <ul class="sub_section"> <li><a href="/chisel3/docs/cookbooks/naming.html" class="">Naming</a></li></ul></li> <li><a href="/chisel3/explanations.html" class="">Explanations</a> <ul class="sub_section"> <li><a href="/chisel3/docs/explanations/annotations.html" class="">Annotations</a></li> <li><a href="/chisel3/docs/explanations/blackboxes.html" class="">Blackboxes</a></li> <li><a href="/chisel3/docs/explanations/bundles-and-vecs.html" class="">Bundles and Vecs</a></li> <li><a href="/chisel3/docs/explanations/multi-clock.html" class="">Multiple Clock Domains</a></li> <li><a href="/chisel3/docs/explanations/naming.html" class="">Naming</a></li></ul></li> <li><a href="/chisel3/wiki-deprecated.html" class="">Wiki (Deprecated)</a> <ul class="sub_section"> <li><a href="/chisel3/docs/wiki-deprecated/introduction.html" class="">Introduction</a></li> <li><a href="/chisel3/docs/wiki-deprecated/supported-hardware.html" class="">Supported Hardware</a></li> <li><a href="/chisel3/docs/wiki-deprecated/data-types.html" class="">Data Types</a></li> <li><a href="/chisel3/docs/wiki-deprecated/combinational-circuits.html" class="">Combinational Circuits</a></li> <li><a href="/chisel3/docs/wiki-deprecated/operators.html" class="">Operators</a></li> <li><a href="/chisel3/docs/wiki-deprecated/width-inference.html" class="">Width Inference</a></li> <li><a href="/chisel3/docs/wiki-deprecated/functional-abstraction.html" class="">Functional Abstraction</a></li> <li><a href="/chisel3/docs/wiki-deprecated/ports.html" class="">Ports</a></li> <li><a href="/chisel3/docs/wiki-deprecated/modules.html" class="">Modules</a></li> <li><a href="/chisel3/docs/wiki-deprecated/sequential-circuits.html" class="">Sequential Circuits</a></li> <li><a href="/chisel3/docs/wiki-deprecated/memories.html" class="">Memories</a></li> <li><a href="/chisel3/docs/wiki-deprecated/interfaces-and-connections.html" class="">Interfaces and Connections</a></li> <li><a href="/chisel3/docs/wiki-deprecated/functional-module-creation.html" class=" active ">Functional Module Creation</a></li> <li><a href="/chisel3/docs/wiki-deprecated/muxes-and-input-selection.html" class="">Muxes and Input Selection</a></li> <li><a href="/chisel3/docs/wiki-deprecated/polymorphism-and-parameterization.html" class="">Polymorphism and Parameterization</a></li> <li><a href="/chisel3/docs/wiki-deprecated/printing.html" class="">Printing in Chisel</a></li> <li><a href="/chisel3/docs/wiki-deprecated/unconnected-wires.html" class="">Unconnected Wires</a></li> <li><a href="/chisel3/docs/wiki-deprecated/reset.html" class="">Reset</a></li> <li><a href="/chisel3/docs/wiki-deprecated/chisel3-vs-chisel2.html" class="">Appendix</a></li></ul></li> <li><a href="/chisel3/docs/wiki-deprecated/developers.html" class="">Developers</a> <ul class="sub_section"> <li><a href="/chisel3/docs/wiki-deprecated/sbt-subproject.html" class="">sbt Subproject</a></li> <li><a href="/chisel3/docs/wiki-deprecated/test-coverage.html" class="">Test Coverage</a></li></ul></li> <li><a href="/api/latest/" class="">API Documentation</a> <ul class="sub_section"> <li><a href="/api/SNAPSHOT/" class="">SNAPSHOT</a></li> <li><a href="/api/3.4.0/" class="">3.4.0</a></li> <li><a href="/api/3.3.2/" class="">3.3.2</a></li> <li><a href="/api/3.3.1/" class="">3.3.1</a></li> <li><a href="/api/3.3.0/" class="">3.3.0</a></li> <li><a href="/api/3.2.7/" class="">3.2.7</a></li> <li><a href="/api/3.2.6/" class="">3.2.6</a></li> <li><a href="/api/3.2.5/" class="">3.2.5</a></li> <li><a href="/api/3.2.4/" class="">3.2.4</a></li> <li><a href="/api/3.2.3/" class="">3.2.3</a></li> <li><a href="/api/3.2.2/" class="">3.2.2</a></li> <li><a href="/api/3.2.1/" class="">3.2.1</a></li> <li><a href="/api/3.2.0/" class="">3.2.0</a></li> <li><a href="/api/3.1.8/" class="">3.1.8</a></li> <li><a href="/api/3.1.7/" class="">3.1.7</a></li> <li><a href="/api/3.1.6/" class="">3.1.6</a></li> <li><a href="/api/3.1.5/" class="">3.1.5</a></li> <li><a href="/api/3.1.4/" class="">3.1.4</a></li> <li><a href="/api/3.1.3/" class="">3.1.3</a></li> <li><a href="/api/3.1.2/" class="">3.1.2</a></li> <li><a href="/api/3.1.1/" class="">3.1.1</a></li> <li><a href="/api/3.1.0/" class="">3.1.0</a></li> <li><a href="/api/3.0.2/" class="">3.0.2</a></li> <li><a href="/api/3.0.1/" class="">3.0.1</a></li> <li><a href="/api/3.0.0/" class="">3.0.0</a></li></ul></li>            </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"></ul></div></div></div></div><div id="content" data-github-owner="freechipsproject" data-github-repo="chisel3"><div class="content-wrapper"><section><p>Objects in Scala have a pre-existing creation function (method) called <code class="highlighter-rouge">apply</code>.
When an object is used as value in an expression (which basically means that the constructor was called), this method determines the returned value.
When dealing with hardware modules, one would expect the module output to be representative of the hardware module’s functionality.
Therefore, we would sometimes like the module output to be the value returned when using the object as a value in an expression.
Since hardware modules are represented as Scala objects, this can be done by defining the object’s <code class="highlighter-rouge">apply</code> method to return the module’s output.
This can be referred to as creating a functional interface for module construction.
If we apply this on the standard mux2 example, we would to return the mux2 output ports when we used mux2 in an expression.
Implementing this requires building a constructor that takes multiplexer inputs as parameters and returns the multiplexer output:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Mux2</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">sel</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">,</span> <span class="n">in0</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">,</span> <span class="n">in1</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">m</span> <span class="k">=</span> <span class="nc">Module</span><span class="o">(</span><span class="k">new</span> <span class="nc">Mux2</span><span class="o">)</span>
    <span class="nv">m</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in0</span> <span class="o">:=</span> <span class="n">in0</span>
    <span class="nv">m</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in1</span> <span class="o">:=</span> <span class="n">in1</span>
    <span class="nv">m</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">sel</span> <span class="o">:=</span> <span class="n">sel</span>
    <span class="nv">m</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">out</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>As we can see in the code example, we defined the <code class="highlighter-rouge">apply</code> method to take the Mux2 inputs as the method parameters, and return the Mux2 output as the function’s return value.
By defining modules in this way, it is easier to later implement larger and more complex version of this regular module.
For example, we previously implemented Mux4 like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Mux4</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">in0</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">in1</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">in2</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">in3</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">sel</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">2.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">out</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="k">val</span> <span class="nv">m0</span> <span class="k">=</span> <span class="nc">Module</span><span class="o">(</span><span class="k">new</span> <span class="nc">Mux2</span><span class="o">)</span>
  <span class="nv">m0</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">sel</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">sel</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
  <span class="nv">m0</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in0</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in0</span>
  <span class="nv">m0</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in1</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in1</span>

  <span class="k">val</span> <span class="nv">m1</span> <span class="k">=</span> <span class="nc">Module</span><span class="o">(</span><span class="k">new</span> <span class="nc">Mux2</span><span class="o">)</span>
  <span class="nv">m1</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">sel</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">sel</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
  <span class="nv">m1</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in0</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in2</span>
  <span class="nv">m1</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in1</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in3</span>

  <span class="k">val</span> <span class="nv">m3</span> <span class="k">=</span> <span class="nc">Module</span><span class="o">(</span><span class="k">new</span> <span class="nc">Mux2</span><span class="o">)</span>
  <span class="nv">m3</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">sel</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">sel</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="nv">m3</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in0</span> <span class="o">:=</span> <span class="nv">m0</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">out</span>
  <span class="nv">m3</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in1</span> <span class="o">:=</span> <span class="nv">m1</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">out</span>

  <span class="nv">io</span><span class="o">.</span><span class="py">out</span> <span class="o">:=</span> <span class="nv">m3</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">out</span>
<span class="o">}</span>
</code></pre></div></div>

<p>However, by using the creation function we redefined for Mux2, we can now use the Mux2 outputs as values of the modules themselves
when writing the Mux4 output expression:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Mux4</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">in0</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">in1</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">in2</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">in3</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">sel</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">2.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">out</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="nv">io</span><span class="o">.</span><span class="py">out</span> <span class="o">:=</span> <span class="nc">Mux2</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">sel</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
                 <span class="nc">Mux2</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">sel</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="nv">io</span><span class="o">.</span><span class="py">in0</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in1</span><span class="o">),</span>
                 <span class="nc">Mux2</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">sel</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="nv">io</span><span class="o">.</span><span class="py">in2</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in3</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This allows to write more intuitively readable hardware connection descriptions, which are similar to software expression evaluation.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'freechipsproject/chisel3'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>